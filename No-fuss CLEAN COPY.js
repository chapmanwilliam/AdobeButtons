 //This strips the pdf of all annotations

var CopyandClean = app.trustedFunction(function()
{ // Privileged context is necessary to prevent JavaScript warning messages on dialog

<<<<<<< HEAD
   if(!CheckPermitted())return;
=======
   if(!CheckLicence())return;
>>>>>>> 9a8c3ab (first commit)

   app.beginPriv();
   
    //Save this as a copy appended with 'TABLET'
   var doc_path=this.path.replace(/\/[^\/]+pdf$/,"/");
   var name=this.documentFileName.replace(/\.pdf$/,"") ;

	 //Save a copy
   try{
	   	 console.println("Saving copy" + doc_path+name+ " CLEAN COPY.pdf");
	  	 this.saveAs({cPath: doc_path+name + " CLEAN.pdf", bCopy: true});
   }catch(e){
         app.alert("Error during save of clean copy");
   }

	 //Open the copy and flatten it
   try{
   	console.println("Opening copy " + doc_path+name + " CLEAN.pdf");
   	var d=app.openDoc({cPath:doc_path+name+" CLEAN.pdf",bHidden:true});
	CleanPages(d); 
	SetWatermarkState(d, false);

   	d.info.clean=true;
  	}catch(e){
         app.alert("Error while trying to re-open copy");
 	}
   	
	 //Save
    try{
	   	console.println("Saving clean copy " + doc_path+name+ " CLEAN.pdf");
	    d.saveAs({cPath: doc_path+name + " CLEAN.pdf"});
   	 }catch(e){
         app.alert("Error during save of clean copy");
     }
     d.closeDoc(true);  //close
     app.endPriv();
});

var CleanPages=app.trustedFunction(function(oDoc)
{
	app.beginPriv();
	if(!oDoc){console.println("Null doc");return;}
	oDoc.syncAnnotScan();
	console.println("Cleaning document...");
	var annots=oDoc.getAnnots();	
	for (var i=0;i<annots.length; i++) annots[i].destroy();	
	app.endPriv();
});

function SetWatermarkState(doc, bState) {
/* set the "Watermark" to bState for doc
doc - doc objet to process
bState - value for logical state
true = show
false = hide
*/

var ocgArray = doc.getOCGs();
for (var i=0; i < ocgArray.length; i++) {
if (ocgArray[i].name == "Watermark") {
ocgArray[i].state = bState;
} // end if Watermark
} // end loop through the OCG object
return;
} // end SetWatermarkState function




 //</CodeAbove>

 //<JSCodeSnippet name="ImageData6">
var strData6CleanPages = 
"00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004e000000eb000000920000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005000000db000000ff000000ee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006d000000ff000000ff000000960000004e000000c6000000720000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000e6000000ff000000ff0000003d000000ec000000ff000000ff0000001f000000320000006d00000000000000000000000000000000000000000000000000000000000000000000000000000078000000ff000000ff000000df00000001000000c6000000ff000000ea0000000e0000006b000000cd000000000000000000000000000000000000000000000000000000000000000000000011000000ee000000ff000000ff00000084000000000000001000000055000000210000000000000000000000000000000000000000000000000000000000000000000000040000003f0000004b000000250000008a000000ef000000ff000000280000000000000000000000000000000100000075000000c40000008e0000000b00000000000000000000000000000001000000b9000000ff000000ff000000f50000009600000032000000570000000000000000000000000000000000000059000000ff000000ff000000ff0000008a0000000000000000000000000000002400000063000000e5000000ff000000ff000000ff000000fd000000a50000000f0000000000000000000000000000008c000000ff000000ff000000ff000000be000000000000000000000000000000be000000930000002b0000008b000000d1000000ff000000ff000000ff000000a500000000000000000000000000000040000000fe000000ff000000ff0000007000000000000000030000008a000000380000008d000000e70000009d0000003b0000007f000000c3000000ff000000f80000000100000000000000000000000000000043000000910000005b0000000100000008000000a4000000ff000000e00000008d0000003d0000007c000000ec000000a90000003f0000005800000064000000000000000000000000000000000000000000000000000000030000004f000000d5000000ff000000ff000000ff000000ff000000d800000085000000350000006e000000eb000000d6000000710000000000000000000000000000003a0000008a000000ad000000e6000000ff000000ff000000ff000000ff000000ff000000ff000000ff000000ff000000e2000000a400000027000000440000001e0000000000000000000000000000003b000000f6000000ff000000ff000000ff000000ff000000fe0000006c000000ba000000ff000000ff000000ff000000ff000000ff000000ff000000d2000000030000000000000000000000000000000000000049000000f6000000ff000000ff000000db0000004e00000085000000ff000000ff000000ea0000007c000000ff000000ff000000ff0000006300000000000000000000000000000000000000000000000000000038000000730000004600000038000000bd000000ff000000ff000000f80000003e000000b9000000ff000000ff000000db00000005000000000000000000000000000000000000000000000000000000000000000300000088000000ff000000ff000000ff000000ef0000004600000092000000ff000000ff000000fb0000003b000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000af0000009500000030000000a7000000ff000000ff000000ff000000760000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000009e000000dd000000fc0000007b0000000000000000000000000000000000000000000000";
 //</JSCodeSnippet>


 // Icon Generic Stream Object
 //<JSCodeSnippet name="ButtonIconDef">
var oIconCleanPages = null;
 //if(app.viewerVersion < 7){
oIconCleanPages = {count: 0, width: 20, height: 20,
read: function(nBytes){return strData6CleanPages.slice(this.count, this.count += nBytes);}};
 //}else{
 //}
 //</JSCodeSnippet>

 //<JSCodeSnippet name="EventCode">
 //</JSCodeSnippet>

 //<JSCodeSnippet name="ButtonObjDef">
var oButObjCleanPages = 
{cName: "CleanPages",
cExec: "CopyandClean()",
cEnable: "event.rc = (app.doc != null)",
cMarked: "event.rc = false",
cTooltext: "Creates clean copy without annotations",
oIcon: oIconCleanPages,
cLabel: "Clean copy"};
 //</JSCodeSnippet>

try{app.removeToolButton("CleanPages");}catch(e){}

 //<JSCodeSnippet name="TryAddBut">
try
{
 //</JSCodeSnippet>
 //<JSCodeSnippet name="AddButtonfn">
    app.addToolButton(oButObjCleanPages);
 //</JSCodeSnippet>
}catch(e){}
 //</JSCodeSnippet>
 






